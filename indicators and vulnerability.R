library("tidyverse")
library("gtsummary")
library("kableExtra")
library("lubridate")
library("scales")


#can't read locally because it's too big
#json_file3 <- "https://bioportal.salud.pr.gov/api/administration/reports/minimal-info-unique-tests"
#url3 <- jsonlite::fromJSON(json_file3)

#PR cases by city & ageRange
#casesPR <- url3 %>% filter(result == "Positive 2019-nCoVtestType" | result == "Positive") %>%
  #filter(testType=="Molecular") %>%
  #select(-c(collectedDate,collectedDateUtc,reportedDate,reportedDateUtc,testType,result,createdAt,createdAtUtc))

#cases as of February 15, 2022
#write_csv(casesPR,"cases")

#read locally
cases <- read.csv("cases.csv") %>% group_by(ageRange, city) %>%
  summarize(cases = sum(n()), .groups = "drop")

#standard population
st_pop_function <- function(x) {
  if (x == "0 to 9") {
    result <- 38907
  } else if (x == "10 to 19") {
    result <- 39877
  } else if (x == "20 to 29") {
    result <- 35979
  } else if (x == "30 to 39") {
    result <- 41691
  } else if (x == "40 to 49") {
    result <- 42285
  } else if (x == "50 to 59") {
    result <- 30531
  } else if (x == "60 to 69") {
    result <- 20064
  } else if (x == "70 to 79") {
    result <- 16141
  } else if (x == "80+") {
    result <- 9159
  } else {
    result <- NA
  }
  return(result)
}

#weighted mean vulnerability by region

pop_estimates <- read_csv("prm-est2019-agesex.csv")

pop_est_muni <- pop_estimates %>% filter(YEAR == 12) %>% select(MUNICIPIO, NAME, POPESTIMATE)

pop_est_region <- pop_estimates %>% select(YEAR, MUNICIPIO, NAME, AGE04_TOT, AGE59_TOT, AGE1014_TOT, AGE1519_TOT, AGE2024_TOT, 
                                       AGE2529_TOT, AGE3034_TOT, AGE3539_TOT, AGE4044_TOT, AGE4549_TOT, AGE5054_TOT,
                                       AGE5559_TOT, AGE6064_TOT, AGE6569_TOT, AGE7074_TOT, AGE7579_TOT, AGE8084_TOT,
                                       AGE85PLUS_TOT) %>% filter(YEAR == 12) %>% mutate(Region = case_when(MUNICIPIO %in% c("013","017","027","039",
                                       "054","065","081","091","101","115","141","145")~"Arecibo",
                                       MUNICIPIO %in% c("019","021","033","047","051","105","107","135","137","143","045")~"Bayamon",
                                       MUNICIPIO %in% c("029","031","061","087","127","139")~"Metro",
                                       MUNICIPIO %in% c("007","009","025","035","041","063","069","077","085","095","103","129","151")~"Caguas",
                                       MUNICIPIO %in% c("037","049","053","089","119","147")~"Fajardo",
                                       MUNICIPIO %in% c("003","005","011","023","067","071","079","083","093","097","099","117","121","125","131")~"Mayaguez",
                                       MUNICIPIO %in% c("001","015","055","057","059","073","075","043","109","111","113","123","133","149","153")~"Ponce"))

agegrp_function <- function(x) {
  if (x == "AGE04_TOT") {
    result <- "0 to 4"
  } else if (x == "AGE59_TOT") {
    result <- "5 to 9"
  } else if (x == "AGE1014_TOT") {
    result <- "10 to 14"
  } else if (x == "AGE1519_TOT") {
    result <- "15 to 19"
  } else if (x == "AGE2024_TOT") {
    result <- "20 to 24"
  } else if (x == "AGE2529_TOT") {
    result <- "25 to 29"
  } else if (x == "AGE3034_TOT") {
    result <- "30 to 34"
  } else if (x == "AGE3539_TOT") {
    result <- "35 to 39"
  } else if (x == "AGE4044_TOT") {
    result <- "40 to 44"
  } else if (x == "AGE4549_TOT") {
    result <- "45 to 49"
  } else if (x == "AGE5054_TOT") {
    result <- "50 to 54"
  } else if (x == "AGE5559_TOT") {
    result <- "55 to 59"
  } else if (x == "AGE6064_TOT") {
    result <- "60 to 64"
  } else if (x == "AGE6569_TOT") {
    result <- "65 to 69"
  } else if (x == "AGE7074_TOT") {
    result <- "70 to 74"
  } else if (x == "AGE7579_TOT") {
    result <- "75 to 79"
  } else if (x == "AGE8084_TOT") {
    result <- "80 to 84"
  } else {
    result <- "85 to 89"
  }
  return(result)
}

pop_est_region2 <- pop_est_region %>% select(-c(NAME, YEAR, MUNICIPIO)) %>% 
  pivot_longer(-Region, names_to = "age_group", values_to = "pop_est") %>% 
  mutate(ageRange = lapply(age_group, agegrp_function)) %>% 
  group_by(Region,.add = T) %>%
  rename(region = Region) %>% summarize(pop_est = sum(pop_est), .groups = "keep") 

pop_est_muni2 <- pop_est_muni %>% mutate(Region = case_when(MUNICIPIO %in% c("013","017","027","039",
                                                                             "054","065","081","091","101","115","141","145")~"Arecibo",
                                                            MUNICIPIO %in% c("019","021","033","047","051","105","107","135","137","143","045")~"Bayamon",
                                                            MUNICIPIO %in% c("029","031","061","087","127","139")~"Metro",
                                                            MUNICIPIO %in% c("007","009","025","035","041","063","069","077","085","095","103","129","151")~"Caguas",
                                                            MUNICIPIO %in% c("037","049","053","089","119","147")~"Fajardo",
                                                            MUNICIPIO %in% c("003","005","011","023","067","071","079","083","093","097","099","117","121","125","131")~"Mayaguez",
                                                            MUNICIPIO %in% c("001","015","055","057","059","073","075","043","109","111","113","123","133","149","153")~"Ponce"))

pop_est_Pon <- pop_est_muni2 %>% filter(Region=="Ponce") %>% 
  mutate(region_pop = rep(474603,times=15)) %>%
  mutate(pop_wt = POPESTIMATE/region_pop) 

pop_est_May <- pop_est_muni2 %>% filter(Region=="Mayaguez") %>% 
  mutate(region_pop = rep(459487,times=15)) %>%
  mutate(pop_wt = POPESTIMATE/region_pop) 

pop_est_Bay <- pop_est_muni2 %>% filter(Region=="Bayamon") %>% 
  mutate(region_pop = rep(537123,times=11)) %>%
  mutate(pop_wt = POPESTIMATE/region_pop) 

pop_est_Met <- pop_est_muni2 %>% filter(Region=="Metro") %>% 
  mutate(region_pop = rep(682054,times=6)) %>%
  mutate(pop_wt = POPESTIMATE/region_pop) 

pop_est_Cag <- pop_est_muni2 %>% filter(Region=="Caguas") %>% 
  mutate(region_pop = rep(529505,times=13)) %>%
  mutate(pop_wt = POPESTIMATE/region_pop) 

pop_est_Faj <- pop_est_muni2 %>% filter(Region=="Fajardo") %>% 
  mutate(region_pop = rep(116148,times=6)) %>%
  mutate(pop_wt = POPESTIMATE/region_pop) 

pop_est_Are <- pop_est_muni2 %>% filter(Region=="Arecibo") %>% 
  mutate(region_pop = rep(394774,times=12)) %>%
  mutate(pop_wt = POPESTIMATE/region_pop) 

pop_wts <- bind_rows(pop_est_Are, pop_est_Bay, pop_est_Cag, pop_est_Faj, pop_est_Met, pop_est_May,pop_est_Pon) %>% 
  group_by(NAME,.add = T) %>%
  arrange(NAME) %>% select(-c(POPESTIMATE, region_pop))

vuln <- read_csv("SVI de tormos et al.csv") %>% select(GEOID, MunicipalArea, overall, SOCECO) %>%
  group_by(MunicipalArea,.add = T) %>% 
  filter(SOCECO>0, overall>0) %>%
  summarize(mean_overall = mean(overall), mean_socio = mean(SOCECO),.groups = "keep")

vuln<-vuln[-c(8, 11, 15, 17, 23, 33, 39, 43, 45, 47, 50, 57, 60, 61, 64, 67),]

add1<- data.frame("Anasco",0.6886258,0.5836917)
names(add1) <- names(vuln)

add2<- data.frame("Bayamon",0.4143083,0.2868522)
names(add2) <- names(vuln)

add3<- data.frame("Canovanas",0.4454382,0.3258405)
names(add3) <- names(vuln)

add4<- data.frame("Catano",0.4400039,0.6763953)
names(add4) <- names(vuln)

add5<- data.frame("Comerio",0.6785437,0.8129088)
names(add5) <- names(vuln)

add6<- data.frame("Guanica",0.2734629,0.7454130)
names(add6) <- names(vuln)

add7<- data.frame("Juana Diaz",0.7645077,0.5473292)
names(add7) <- names(vuln)

add8<- data.frame("Las Marias",0.4456800,0.6769355)
names(add8) <- names(vuln)

add9<- data.frame("Loiza",0.5121517,0.5154944)
names(add9) <- names(vuln)

add10<- data.frame("Manati",0.7047089,0.4891578)
names(add10) <- names(vuln)

add11<- data.frame("Mayaguez",0.5204107,0.5058994)
names(add11) <- names(vuln)

add12<- data.frame("Penuelas",0.1019425,0.4413851)
names(add12) <- names(vuln)

add13<- data.frame("Rincon",0.8266456,0.5757431)
names(add13) <- names(vuln)

add14<- data.frame("Rio Grande",0.6252093,0.4758292)
names(add14) <- names(vuln)

add15<- data.frame("San German",0.6196502,0.5601976)
names(add15) <- names(vuln)

add16<- data.frame("San Sebastian",0.7806206,0.8416909)
names(add16) <- names(vuln)

#sum weighted vulnerability indexes by region
vuln2 <-vuln %>% rbind(add1,add2,add3,add4,add5,add6,add7,add8,add9,add10,add11,add12,add13,add14,add15,add16) %>% 
  arrange(MunicipalArea)

socioeco_vuln <- vuln2 %>% select(-mean_overall)
overall_vuln <- vuln2 %>% select(-mean_socio)

socioeco_vuln2<- bind_cols(socioeco_vuln, pop_wts) %>% mutate(weighted_vuln = mean_socio*pop_wt) %>% 
  group_by(Region) %>% select(-MunicipalArea,MUNICIPIO,NAME) %>% summarize(mean_socioecovuln = sum(weighted_vuln),.groups = "keep")

overall_vuln2 <- bind_cols(overall_vuln, pop_wts) %>% mutate(weighted_vuln = mean_overall*pop_wt) %>%
  group_by(Region) %>% select(-MunicipalArea,MUNICIPIO,NAME) %>% summarize(mean_socialvuln = sum(weighted_vuln),.groups = "keep")

#making tables with vulnerability by municipality

vuln3 <- vuln2 %>% mutate(region = case_when(MunicipalArea %in% c("Carolina","San Juan","Guaynabo","Loiza","Trujillo Alto","Canovanas")~"Metro",
                                                      MunicipalArea %in% c("Arecibo","Hatillo","Camuy","Quebradillas","Vega Baja","Barceloneta","Florida",
                                                      "Manati","Morovis","Ciales","Lares","Utuado")~"Arecibo",
                                                      MunicipalArea %in% c("Catano","Bayamon","Vega Alta","Toa Alta","Dorado","Comerio","Barranquitas",
                                                      "Corozal","Orocovis","Naranjito","Toa Baja")~"Bayamon",
                                                      MunicipalArea %in% c("Aguas Buenas","Caguas","Gurabo","Cayey","Cidra","Aibonito",
                                                      "Maunabo","Yabucoa","Humacao","Naguabo","San Lorenzo","Juncos","Las Piedras")~"Caguas",
                                                      MunicipalArea %in% c("Luquillo","Fajardo","","Rio Grande","Ceiba","Culebra","Vieques")~"Fajardo",
                                                      MunicipalArea %in% c("Mayaguez","Aguadilla","Isabela","Moca","Aguada","Rincon",
                                                      "San Sebastian","Las Marias","Anasco","Maricao","San German","Cabo Rojo","Hormigueros",
                                                      "Sabana Grande","Lajas")~"Mayaguez", MunicipalArea %in% c("Penuelas","Adjuntas","Jayuya","Ponce","Juana Diaz",
                                                      "Villalba","Coamo","Santa Isabel","Guayama","Arroyo","Patillas","Salinas","Guanica","Guayanilla","Yauco")~"Ponce"))

vuln_Pon <- vuln3 %>% filter(region=="Ponce") %>% select(-region) %>% kbl(align="r",caption = "Ponce region: social vulnerability and socioeconomic vulnerability by municipality") %>%
  kable_styling(bootstrap_options = "basic")

vuln_Faj <- vuln3 %>% filter(region=="Fajardo") %>% select(-region) %>% kbl(align="r",caption = "Fajardo region: social vulnerability and socioeconomic vulnerability by municipality") %>%
  kable_styling(bootstrap_options = "basic")

vuln_Are <- vuln3 %>% filter(region=="Arecibo") %>% select(-region) %>% kbl(align="r",caption = "Arecibo region: social vulnerability and socioeconomic vulnerability by municipality") %>%
  kable_styling(bootstrap_options = "basic")

vuln_Met <- vuln3 %>% filter(region=="Metro") %>% select(-region) %>% kbl(align="r",caption = "Metro region: social vulnerability and socioeconomic vulnerability by municipality") %>%
  kable_styling(bootstrap_options = "basic")

vuln_Bay <- vuln3 %>% filter(region=="Bayamon") %>% select(-region) %>% kbl(align="r",caption = "Bayamon region: social vulnerability and socioeconomic vulnerability by municipality") %>%
  kable_styling(bootstrap_options = "basic")

vuln_May <- vuln3 %>% filter(region=="Mayaguez") %>% select(-region) %>% kbl(align="r",caption = "Mayaguez region: social vulnerability and socioeconomic vulnerability by municipality") %>%
  kable_styling(bootstrap_options = "basic")

vuln_Cag <- vuln3 %>% filter(region=="Caguas") %>% select(-region) %>% kbl(align="r",caption = "Caguas region: social vulnerability and socioeconomic vulnerability by municipality") %>%
  kable_styling(bootstrap_options = "basic")

# PR population estimates for age-specific indicators
library(readxl)
pop_estimates_byageRange_region <- read_excel("pop_est.xlsx")

ages4 <- c("0 to 9","10 to 19","20 to 29","30 to 39","40 to 49","50 to 59","60 to 69","70 to 79","80+")

#incidence
inci <- pop_estimates_byageRange_region %>% mutate(st_pop = lapply(ageRange, st_pop_function))

#mortality
mort <- pop_estimates_byageRange_region %>% mutate(st_pop = lapply(ageRange, st_pop_function))

#case-fatality rate
json_file <- "https://bioportal.salud.pr.gov/api/administration/reports/deaths/summary"

first_day <- make_date(2020, 3, 12)

deaths <- jsonlite::fromJSON(json_file) %>%
  mutate(date = as_date(ymd_hms(deathDate, tz = "America/Puerto_Rico"))) %>%
  mutate(date = if_else(date < first_day | date > today(),
                        as_date(ymd_hms(reportDate, tz = "America/Puerto_Rico")),
                        date))

cfr <-  deaths %>% mutate(st_pop = lapply(ageRange, st_pop_function)) 
#a√±adir casos por edad

json_file3 <- "https://bioportal.salud.pr.gov/api/administration/reports/minimal-info-unique-tests"
url3 <- jsonlite::fromJSON(json_file3)

#standard population
st_pop_function <- function(x) {
  if (x == "0 to 9") {
    result <- 38907
  } else if (x == "10 to 19") {
    result <- 39877
  } else if (x == "20 to 29") {
    result <- 35979
  } else if (x == "30 to 39") {
    result <- 41691
  } else if (x == "40 to 49") {
    result <- 42285
  } else if (x == "50 to 59") {
    result <- 30531
  } else if (x == "60 to 69") {
    result <- 20064
  } else if (x == "70 to 79") {
    result <- 16141
  } else if (x == "80+") {
    result <- 9159
  } else {
    result <- NA
  }
  return(result)
}

# PR population estimates
pop_estimates <- read_csv("prm-est2019-agesex.csv")

pop_est_df <- pop_estimates %>% select(YEAR, MUNICIPIO, NAME, AGE04_TOT, AGE59_TOT, AGE1014_TOT, AGE1519_TOT, AGE2024_TOT, 
                                       AGE2529_TOT, AGE3034_TOT, AGE3539_TOT, AGE4044_TOT, AGE4549_TOT, AGE5054_TOT,
                                       AGE5559_TOT, AGE6064_TOT, AGE6569_TOT, AGE7074_TOT, AGE7579_TOT, AGE8084_TOT,
                                       AGE85PLUS_TOT) %>% filter(YEAR == 12) %>% mutate(Region = case_when(MUNICIPIO %in% c("013","017","027","039",
                                                                                                                            "054","065","081","091","101","115","141","145")~"Arecibo",
                                                                                                           MUNICIPIO %in% c("019","021","033","047","051","105","107","135","137","143","045")~"Bayamon",
                                                                                                           MUNICIPIO %in% c("029","031","061","087","127","139")~"Metro",
                                                                                                           MUNICIPIO %in% c("007","009","025","035","041","063","069","077","085","095","103","129","151")~"Caguas",
                                                                                                           MUNICIPIO %in% c("037","049","053","089","119","147")~"Fajardo",
                                                                                                           MUNICIPIO %in% c("003","005","011","023","067","071","079","083","093","097","099","117","121","125","131")~"Mayaguez",
                                                                                                           MUNICIPIO %in% c("001","015","055","057","059","073","075","043","109","111","113","123","133","149","153")~"Ponce"))

agegrp_function <- function(x) {
  if (x == "AGE04_TOT") {
    result <- "0 to 4"
  } else if (x == "AGE59_TOT") {
    result <- "5 to 9"
  } else if (x == "AGE1014_TOT") {
    result <- "10 to 14"
  } else if (x == "AGE1519_TOT") {
    result <- "15 to 19"
  } else if (x == "AGE2024_TOT") {
    result <- "20 to 24"
  } else if (x == "AGE2529_TOT") {
    result <- "25 to 29"
  } else if (x == "AGE3034_TOT") {
    result <- "30 to 34"
  } else if (x == "AGE3539_TOT") {
    result <- "35 to 39"
  } else if (x == "AGE4044_TOT") {
    result <- "40 to 44"
  } else if (x == "AGE4549_TOT") {
    result <- "45 to 49"
  } else if (x == "AGE5054_TOT") {
    result <- "50 to 54"
  } else if (x == "AGE5559_TOT") {
    result <- "55 to 59"
  } else if (x == "AGE6064_TOT") {
    result <- "60 to 64"
  } else if (x == "AGE6569_TOT") {
    result <- "65 to 69"
  } else if (x == "AGE7074_TOT") {
    result <- "70 to 74"
  } else if (x == "AGE7579_TOT") {
    result <- "75 to 79"
  } else if (x == "AGE8084_TOT") {
    result <- "80 to 84"
  } else {
    result <- "85+"
  }
  return(result)
}

pop_est_by_region <- pop_est_df %>% select(-c(NAME, YEAR, MUNICIPIO)) %>% 
  pivot_longer(-Region, names_to = "age_group", values_to = "pop_est") %>% 
  mutate(ageRange = lapply(age_group, agegrp_function)) %>% 
  group_by(Region, ageRange,.add = T) %>%
  rename(region = Region) %>% summarize(pop_est = sum(pop_est), .groups = "keep") 

#changing age ranges by region

arecibo_pop<- filter(pop_est_by_region, region == "Arecibo")

bayamon_pop<- filter(pop_est_by_region, region == "Bayamon")

metro_pop<- filter(pop_est_by_region, region == "Metro")

caguas_pop<- filter(pop_est_by_region, region == "Caguas")

fajardo_pop<- filter(pop_est_by_region, region == "Fajardo")

mayaguez_pop<- filter(pop_est_by_region, region == "Mayaguez")

ponce_pop<- filter(pop_est_by_region, region == "Ponce")

#vulnerability
vuln <- read_csv("SVI de tormos et al.csv")